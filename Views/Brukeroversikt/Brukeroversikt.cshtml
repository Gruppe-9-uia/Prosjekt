@model List<Prosjekt.Entities.EmployeeUser>

@{
    ViewData["Title"] = "Brukeroversikt";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nøsted & Brukeroversikt</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">  <!-- css for pop up -->
    <link href="/css/Brukeroversikt-popup.css" rel="stylesheet"> <!-- custom css -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container text-center mt-5">
        <header>
            <h1 class="h1-bo">Brukeroversikt</h1>
        </header>
    </div>
    
        <main>
            <div class="container text-center mt-4 mb-4">
                @using (Html.BeginForm("", ""))
                {
                    @Html.AntiForgeryToken()
                    <form class="searchbar" action="/search" method="get">
                        <div class="form-group row justify-content-center">
                            <div class="col-xs-3">
                                <input type="search" class="form-control text-center mb-3" name="q" id="search-box-bo" placeholder="AnsattID, Fullt navn, Stilling...">
                            </div>
                        </div>

                        <div class="search-bo">
                            <button type="submit" class="btn btn-primary" id="searchbutton-bo">Søk</button><!-- søkeknapp- må finne ut hvordan man kan filtrere søkene KONTROLLER -->
                        </div>
                    </form>
                }
            </div>
            
                <div class="container">
                    <div class="table-container" style="max-height: 260px; overflow-x:auto; border: 1px solid #000000;">
                        
                   
                        <table class="table table-striped table-hover" id="table-bo">
                            <thead>
                            <tr>
                                <th>AnsattID</th>
                                <th>Fullt navn</th>
                                <th>Stilling</th>
                                <th>Rettigheter</th>
                            </tr>
                            </thead>

                            <tbody id="userTable">
                            @foreach (var employee in Model)
                            {
                            <tr class="table-row" data-toggle="modal" data-target="#BOModal" data-employee-id="@employee.Id" data-employee-firstname="@employee.FirstName_str" data-employee-lastname="@employee.LastName_str" data-employee-department="@employee.DepartmentID_int" data-employee-level="@employee.Level_str">
                                <td>@employee.Id</td>
                                <td>@(employee.FirstName_str + " " + employee.LastName_str)</td>
                                <td>@employee.DepartmentID_int</td>
                                <td>@employee.Level_str</td>
                            </tr>
                            }
                            </tbody>
                        </table>
                        </div>
                </div>
            
                <!-- pop up -->
                <div class="modal fade" id="BOModal" role="dialog" data-backdrop="static" data-keyboard="false">
                    <div class="modal-dialog">
                        
                        <!-- modal content -->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Rad Detaljer</h4><!-- må koble til database sånn at fullt navn + ansattID kommer opp -->
                            </div>
                            
                            <form action="post">
                                <div class="modal-body" id="BOModalBody">
                                    <img src="~/Images/fram.png" alt="profilbilde-modal" id="modal-pfp-bo"> <!-- profilbilde må kobles til database -->
                                    <div class="row">
                                        <div class="col">
                                            <!-- må koble til database for info --> 
                                            <label for="editStilling"><b>Stilling</b></label>
                                            <input type="text" class="form-control" id="editStilling" placeholder="Stilling" list="stillinglist" readonly required>
                                        
                                            <label for="editEpost"><b>E-post</b></label>
                                            <input type="email" class="form-control" id="editEpost" placeholder="E-post" readonly>
                                        
                                            <label for="editTlf"><b>Telefonnummer</b></label>
                                            <input type="tel" class="form-control" id="editTlf" placeholder="Telefonnummer" readonly>
                                            <br/>
                                        </div>
                                        <div id="additionalInfo" style="display: none;">
                                            <div class="form-row" id="pf-row-1">
                                                <div class="form-group col">
                                                    <label for="pf-fullt-navn"><b>Fullt navn</b></label>
                                                    <input type="text" class="form-control" id="editNavn" placeholder="Fullt navn" required>
                                                </div>
                                                <div class="form-group col">
                                                    <label for="pf-adresse"><b>Adresse</b></label>
                                                    <input type="text" class="form-control" id="editAdresse" placeholder="Adresse" required>
                                                </div>
                                            </div>
                                        
                                            <div class="form-row" id="pf-row-2">
                                                <div class="form-group col">
                                                    <label for="pf-postnr"><b>Postnummer</b></label>
                                                    <input type="text" class="form-control" id="editPostnr" placeholder="Postnummer" required>
                                                </div>
                                                <div class="form-group col">
                                                    <label for="pf-postst"><b>Poststed</b></label>
                                                    <input type="text" class="form-control" id="editPostst" placeholder="Poststed" required>
                                                </div>
                                            </div>
                                            <div class="form-row" id="pf-row-2">
                                                <div class="form-group col">
                                                    <label for="pf-rettigheter"><b>Rettigheter</b></label>
                                                    <input type="text" class="form-control" placeholder="Rettigheter..." name="rettigheter" id="editRettigheter" list="retthet" required>
                                                    <datalist id="retthet">
                                                        <option>Legge til/fjerne bruker</option>
                                                        <option>Fjerne verktøy fra verktøyliste</option>
                                                        <option>Redigere serviceordre</option>
                                                        <option>Legge til ny serviceordre</option>
                                                    </datalist>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                
                                    <div id="info-modal-bo-2">
                                        <p>Arbeidsoppgaver: </p> <!-- koble til database -->
                                        <br/> 
                                
                                        <button type="button" class="btn btn-primary button mb-2" id="edit-button-bo" onclick="editPfFunction()">Endre profil</button>
                                        <button type="button" class="btn btn-success button mb-2" id="save-button-bo" style="display: none;" onclick="savePfFunction()">Lagre profil</button>
                                        <button type="button" class="btn btn-danger button mb-2" id="delete-button-bo" style="display: none;" onclick="deletePfFunction()">Slett bruker</button>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal" id="modal-bo-lukk" onclick="modalLukk()">Lukk</button>
                            </div>
                        </div>
                    </div>
                </div>


                <script>
                    // filtrering av søk
                    $(document).ready(function () {
                        $("#search-box-bo").on("keyup", function () {
                            var value = $(this).val().toLowerCase();
                        $("#userTable tr").filter(function () {
                            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                            });
                        });
                    });
            
                    // pop up
                    $(document).ready(function () {
                        $(".table-row").click(function () {
                            var employeeID = $(this).data("employee-id");
                            var employeeFirstName = $(this).data("employee-firstname");
                            var employeeLastName = $(this).data("employee-lastname");
                            var employeeDepartment = $(this).data("employee-department");
                            var employeeLevel = $(this).data("employee-level");
                        
                            
                            
                            $("#editStilling").val(employeeDepartment);
                            $("#editEpost").val(data.Email);
                            $("#editTlf").val(data.Phone);
                            $("#editNavn").val(employeeFirstName + " " + employeeLastName);
                        
                            $('#BOModal').modal('show');
                            
                            // AJAX call
                            $.get("/Brukeroverikt/GetEmployeeDetails", { employeeID: employeeId }, function (data) {
                                if (data !== null) {
                                    $("editEpost").val(data.Email);
                                    $("editTlf").val(data.Phone);
                                }
                            });
                        });
                     });
                        
                        /*$(".table-row").click(function () {
                            var BOrowData = $(this).data("content").split(",");
                            var BOModalBody = $("#BOModalBody");
                    
                    BOModalBody.empty();
                    
                    for (var i = 0; i < BOrowData.length; i++) {
                        BOModalBody.append("<p><strong>Column " + (i + 1) + ": </strong>" + BOrowData[i] + "</p>");
                            }
                        });
                    });*/
                    
                    // funksjon for å endre readonly inputs
                    function editPfFunction() {
                        var elementsToRemoveReadonly = ['editStilling', 'editEpost', 'editTlf', 'editNavn', 'editAdresse', 'editPostnr', 'editPostst', 'editRettigheter'];
                        elementsToRemoveReadonly.forEach(function (elementId) {
                            document.getElementById(elementId).removeAttribute('readonly');
                        });
                        
                        // viser lagre / slett knappene + ekstra informasjon
                        document.getElementById('save-button-bo').style.display = 'inline-block';
                        document.getElementById('additionalInfo').style.display = 'inline-block';
                        document.getElementById('delete-button-bo').style.display = 'inline-block';
                    }
                    
                    // funksjon for å lagre dataen, inputs-ene går tilbake til å være readonly
                    function savePfFunction() {
                        var elementsToSetReadonly = ['editStilling', 'editEpost', 'editTlf', 'editNavn', 'editAdresse', 'editPostnr', 'editPostst', 'editRettigheter'];
                        elementsToSetReadonly.forEach(function (elementId) {
                            document.getElementById(elementId).setAttribute('readonly', 'true');
                        });
                        
                        //skjule lagre / slett knappene 
                        document.getElementById('save-button-bo').style.display = 'none';
                        document.getElementById('delete-button-bo').style.display = 'none';
                        
                        alert('Informasjonen har blitt lagret!');
                    }
                    
                    //funksjon for å slette brukeren
                    function deletePfFunction() {
                        var isConfirmed = confirm('Er du sikker på at du vil slette denne brukeren?');
                        if (isConfirmed) {
                        // kode for å slette bruker fra databasen
                                                    
                           $('#BOModal').modal('hide');
                            alert('Brukeren har blitt slettet.');
                       }
                    }
                   
                    function modalLukk() {
                        document.getElementById('additionalInfo').style.display = 'none';
                        document.getElementById('save-button-bo').style.display = 'none';
                        document.getElementById('delete-button-bo').style.display = 'none';
                        
                        document.getElementById('editStilling').setAttribute('readonly', 'true');
                        document.getElementById('editEpost').setAttribute('readonly', 'true');
                        document.getElementById('editTlf').setAttribute('readonly', 'true');
                        
                    }
                </script>

            <div class="text-center">
                <a class="btn btn-primary" id="btn-bruker-bo" role="button" href="@Url.Action("CreateUser",  "Brukerregistrering")">Legg til bruker</a>
            </div>
        </main>
</body> 
</html>
